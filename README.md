# MongoDB with Atlas Search (mongot) Docker Compose Setup

This Docker Compose configuration provides a complete MongoDB and MongoDB Atlas Search (mongot) setup with all security prerequisites handled automatically.

## Quick Start
First pull the latest images for mongodb community server and mongodb community search
```bash
docker pull mongodb/mongodb-community-server:latest
docker pull mongodb/mongodb-community-search:latest
```

Fetch the sample data
```bash
curl  https://atlas-education.s3.amazonaws.com/sampledata.archive -o sampledata.archive
```

### Default Setup (default passwords)

The setup process is now a simple two-step workflow:

```bash
# Step 1: Generate security files (keyfile and passwordFile)
ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator

# Step 2: Start all services
docker compose up -d

# Or combine both steps (but step-by-step is recommended for clarity)
ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator && docker compose up -d
```

**Note**: The default passwords are `admin` for the admin user and `mongotPassword` for the mongot user. You can change these values, but if you do, you'll need to update all subsequent commands that use these passwords.

### Custom Passwords

Set your own passwords by passing environment variables:

```bash
# Step 1: Generate security files with custom passwords
ADMIN_PASSWORD="mySecureAdminPass" MONGOT_PASSWORD="mySecureMongotPass" docker compose --profile setup up setup-generator

# Step 2: Start services
docker compose up -d

# Or export them first
export ADMIN_PASSWORD="mySecureAdminPass"
export MONGOT_PASSWORD="mySecureMongotPass"
docker compose --profile setup up setup-generator
docker compose up -d
```

## What This Does

The Docker Compose setup handles the following automatically:

1. **Security Prerequisites**:
   - Generates a keyfile for replica set authentication if it doesn't exist
   - Creates a password file with the specified mongot password
   - Sets proper permissions on security files
   - Creates the required `mongotUser` with `searchCoordinator` role using specified passwords

2. **Service Orchestration**:
   - Starts MongoDB with replica set configuration
   - Waits for MongoDB to be healthy before starting mongot
   - Loads sample data (if `sampledata.archive` exists)
   - Configures proper networking between services

3. **Health Checks**:
   - MongoDB health check to ensure it's ready
   - Mongot health check to verify search service is running

4. **Password Management**:
   - Supports custom passwords via environment variables passed to docker compose
   - Automatically creates password files with specified credentials

## Services

### Setup Generator (setup-generator)
- **Purpose**: Generates keyfile and passwordFile when needed
- **Usage**: Only run with `--profile setup` for initial setup or to recreate security files
- **Container**: `setup-generator` (runs once and exits)

### MongoDB (mongod)
- **Container**: `mongod-community`
- **Port**: 27017
- **Admin User**: admin/[ADMIN_PASSWORD] (default: admin/admin)
- **mongot User**: mongotUser/[MONGOT_PASSWORD] (default: mongotUser/mongotPassword)
- **Replica Set**: rs0
- **Data**: Persisted in `./mongod_data`
- **Requirements**: Needs keyfile and passwordFile to exist (generated by setup-generator)

### MongoDB Atlas Search (mongot)
- **Container**: `mongot-community`
- **Ports**: 
  - 27028 (gRPC server)
  - 8080 (Health check)
  - 9946 (Metrics)
- **Data**: Persisted in `./mongot_data`
- **Dependencies**: Waits for MongoDB to be healthy before starting
- **Requirements**: Needs passwordFile to exist (generated by setup-generator)

## Configuration Files

- `mongod.conf`: MongoDB server configuration
- `mongot.conf`: MongoDB Atlas Search configuration  
- `passwordFile`: Auto-generated file containing the mongot user password
- `keyfile`: Auto-generated replica set keyfile
- `init-mongo.sh`: Initialization script for user creation and data loading

## Service Architecture

The Docker Compose configuration follows a clean two-phase approach:

**Phase 1: Setup** (one-time, uses `--profile setup`):
- `setup-generator`: Creates keyfile and passwordFile, then exits

**Phase 2: Normal Operations** (ongoing use):
- `mongod`: MongoDB service (assumes security files exist from Phase 1)
- `mongot`: MongoDB Atlas Search service (depends on mongod health)

This design separates concerns cleanly: setup is a one-time utility, while the main services run independently without complex dependencies.

## Commands

### First-Time Setup
```bash
# Step 1: Generate security files (default passwords)
ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator

# Step 2: Start services
docker compose up -d
```

### With Custom Passwords
```bash
# Step 1: Generate security files (custom passwords)
ADMIN_PASSWORD="myAdminPass" MONGOT_PASSWORD="myMongotPass" docker compose --profile setup up setup-generator

# Step 2: Start services (will use the passwords set in step 1)
docker compose up -d
```

### Daily Operations
```bash
# Start services (assumes setup was done previously)
docker compose up -d

# View logs
docker compose logs -f

# Stop services
docker compose down

# Stop and remove volumes (WARNING: deletes data)
docker compose down -v

# Check service status
docker compose ps
```

### Access MongoDB
```bash
# With default password
docker compose exec mongod mongosh -u admin -p admin --authenticationDatabase admin

# With custom password (replace with your actual password)
docker compose exec mongod mongosh -u admin -p "your_admin_password" --authenticationDatabase admin
```

## Connecting to Services

### MongoDB Connection
```
# With default passwords
mongodb://admin:admin@localhost:27017/?authSource=admin

# With custom passwords (replace with your actual passwords)
mongodb://admin:[your_admin_password]@localhost:27017/?authSource=admin
```

### mongot Health Check
```
curl http://localhost:8080/health
```

### mongot Metrics
```
curl http://localhost:9946/metrics
```

## Troubleshooting

### Check Service Health
```bash
docker compose ps
docker compose logs mongod
docker compose logs mongot

# Check setup logs if you ran the setup recently
docker compose logs setup-generator
```

### Keyfile Issues
If you encounter keyfile permission issues:
```bash
# Regenerate keyfile and passwordFile
rm keyfile passwordFile
ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator
```

### Reset Everything
```bash
# Stop and remove all data
docker compose down -v
rm -rf mongod_data mongot_data keyfile passwordFile

# Start fresh with default passwords
ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator
docker compose up -d
```

### Change Passwords
To change passwords, stop services, regenerate the password file, and restart:
```bash
# Stop current services
docker compose down

# Remove password file (keyfile can remain)
rm passwordFile

# Regenerate password file with new password
ADMIN_PASSWORD="newAdminPass" MONGOT_PASSWORD="newMongotPass" docker compose --profile setup up setup-generator

# Restart services
docker compose up -d
```

### Common Issues

**Error: "no such file or directory" for keyfile or passwordFile**
- This happens when running `docker compose up` before running the setup phase
- Solution: Run setup first: `ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator`

**Services won't start**
- Check if keyfile and passwordFile exist: `ls -la keyfile passwordFile`
- If missing, run setup: `ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" docker compose --profile setup up setup-generator`
- Then start services: `docker compose up -d`

**MongoDB authentication errors**
- Ensure the passwordFile contains the correct mongot password
- Regenerate if needed: `rm passwordFile && MONGOT_PASSWORD="yourPassword" docker compose --profile setup up setup-generator`

## Network Configuration

The services communicate through a custom bridge network called `search-community`. The hostnames used internally are:
- `mongod.search-community` (MongoDB)
- `mongot-community.search-community` (mongot)

## Data Persistence

- MongoDB data: `./mongod_data`
- MongoDB config: `./mongod_configdb` 
- mongot data: `./mongot_data`
- Sample data: Loaded from `sampledata.archive` if present

All data directories are created automatically and persist between container restarts.

# Prometheus Monitoring Setup

This setup includes comprehensive monitoring with Prometheus and Grafana for both MongoDB Community Server and mongot metrics.

## Quick Start with Monitoring

```bash
# Start the full stack with monitoring
./start-monitoring.sh
```

This provides:
- **MongoDB Community Server**: Monitored via MongoDB Exporter  
- **mongot (Atlas Search)**: Native Prometheus metrics endpoint
- **Prometheus**: Metrics collection and time-series database
- **Grafana**: Visualization and dashboarding

## Access Points

| Service | URL | Default Credentials |
|---------|-----|-------------------|
| Prometheus Web UI | http://localhost:9090 | - |
| Grafana Dashboards | http://localhost:3000 | admin/admin |
| MongoDB Exporter Metrics | http://localhost:9216/metrics | - |
| mongot Native Metrics | http://localhost:9946/metrics | - |

## Available Metrics

- **MongoDB Metrics**: `mongodb_*` (connections, operations, memory, etc.)
- **mongot Metrics**: `mongot_*` (search performance, indexing, etc.)
- **System Metrics**: Standard Prometheus metrics for both services

## Testing the Setup

```bash
# Test all monitoring endpoints
./test-monitoring.sh

# Test dashboard metrics availability
./test-dashboard-metrics.sh

# Generate sample activity to populate dashboard metrics
./demo-dashboard.sh
```

## Pre-built Dashboard

A comprehensive Grafana dashboard is automatically loaded with the following panels:
- **Service Status**: MongoDB and Mongot availability
- **Connection Metrics**: Current and active connections
- **Operations Rate**: Database operations per second by type
- **Memory Usage**: Resident and virtual memory consumption
- **Network I/O**: Bytes in/out rates
- **Search Metrics**: Search command latency, rates, and failures
- **Database Stats**: Collection counts and data sizes
- **WiredTiger Cache**: Cache usage and efficiency
- **Search Performance**: Average latency and executor metrics

The dashboard automatically refreshes every 5 seconds and shows the last hour of data.

See [MONITORING.md](MONITORING.md) for detailed documentation on using Prometheus and Grafana.