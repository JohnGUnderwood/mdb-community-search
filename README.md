# MongoDB with Atlas Search (mongot) Docker Compose Setup

This Docker Compose configuration provides a complete MongoDB and MongoDB Search (mongot) setup with all security prerequisites handled automatically. It will also setup Prometheus and Grafana for monitoring, create search indexes and run test queries to populate metrics.

## Table of Contents
- [Quick Start](#quick-start)
- [Services](#services)
- [Configuration Files](#configuration-files)
- [Commands](#commands)
- [Prometheus Monitoring Setup](#prometheus-monitoring-setup)
- [Troubleshooting](#troubleshooting)

## Quick Start
First pull the latest images for mongodb community server and mongodb community search
```bash
docker pull mongodb/mongodb-community-server:latest
docker pull mongodb/mongodb-community-search:latest
```

Fetch the sample data
```bash
curl  https://atlas-education.s3.amazonaws.com/sampledata.archive -o sampledata.archive
```

### Default Setup (default passwords)

The setup process is now a simple two-step workflow:

```bash
# Step 1: Generate security files (keyfile and passwordFile)
export ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" && export docker compose --profile setup up setup-generator

# Step 2: Start all services
docker compose up mongod mongot -d

# Or combine both steps (but step-by-step is recommended for clarity)
export ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" && docker compose --profile setup up setup-generator && docker compose up mongod mongot -d
```

### With monitoring
You can also start the system with Prometheus and Grafana for monitoring. See [Prometheus Monitoring Setup](#prometheus-monitoring-setup)

**Note**: The default passwords are `admin` for the admin user and `mongotPassword` for the mongot user. You can change these values, but if you do, you'll need to update all subsequent commands that use these passwords.

### Custom Passwords

Set your own passwords by passing environment variables:

```bash
# Step 1: Generate security files with custom passwords
export ADMIN_PASSWORD="mySecureAdminPass" MONGOT_PASSWORD="mySecureMongotPass" && docker compose --profile setup up setup-generator

# Step 2: Start services
docker compose up -d
```

## What This Does

The Docker Compose setup handles the following automatically:

1. **Security Prerequisites**:
   - Generates a keyfile for replica set authentication if it doesn't exist
   - Creates a password file with the specified mongot password
   - Sets proper permissions on security files
   - Creates the required `mongotUser` with `searchCoordinator` role using specified passwords

2. **Service Orchestration**:
   - Starts MongoDB with replica set configuration
   - Waits for MongoDB to be healthy before starting mongot
   - Loads sample data (if `sampledata.archive` exists)
   - Configures proper networking between services

3. **Health Checks**:
   - MongoDB health check to ensure it's ready
   - Mongot health check to verify search service is running

4. **Password Management**:
   - Supports custom passwords via environment variables passed to docker compose
   - Automatically creates password files with specified credentials

## Services

### Setup Generator (setup-generator)
- **Purpose**: Generates keyfile and passwordFile when needed
- **Usage**: Only run with `--profile setup` for initial setup or to recreate security files
- **Container**: `setup-generator` (runs once and exits)

### MongoDB (mongod)
- **Container**: `mongod-community`
- **Port**: 27017
- **Admin User**: admin/[ADMIN_PASSWORD] (default: admin/admin)
- **mongot User**: mongotUser/[MONGOT_PASSWORD] (default: mongotUser/mongotPassword)
- **Replica Set**: rs0
- **Data**: Persisted in volume `mongod_data`
- **Requirements**: Needs keyfile and passwordFile to exist (generated by setup-generator)

### MongoDB Search (mongot)
- **Container**: `mongot-community`
- **Ports**: 
  - 27028 (gRPC server)
  - 8080 (Health check)
  - 9946 (Metrics)
- **Data**: Persisted in volume `mongot_data`
- **Dependencies**: Waits for MongoDB to be healthy before starting
- **Requirements**: Needs passwordFile to exist (generated by setup-generator)

## Configuration Files

- `mongod.conf`: MongoDB server configuration
- `mongot.conf`: MongoDB Atlas Search configuration  
- `passwordFile`: Auto-generated file containing the mongot user password
- `keyfile`: Auto-generated replica set keyfile
- `init-mongo.sh`: Initialization script for user creation and data loading

## Service Architecture

The Docker Compose configuration follows a clean two-phase approach:

**Phase 1: Setup** (one-time, uses `--profile setup`):
- `setup-generator`: Creates keyfile and passwordFile, then exits

**Phase 2: Normal Operations** (ongoing use):
- `mongod`: MongoDB service (assumes security files exist from Phase 1)
- `mongot`: MongoDB Atlas Search service (depends on mongod health)

This design separates concerns cleanly: setup is a one-time utility, while the main services run independently without complex dependencies.

## Commands

### First-Time Setup
```bash
# Step 1: Export passwords as environment variables (you can change these)
export ADMIN_PASSWORD="admin"
export MONGOT_PASSWORD="mongotPassword"

# Step 2: Generate security files (uses passwords above)
 docker compose --profile setup up setup-generator

# Step 2: Start services
docker compose up -d
```

### Daily Operations
```bash
# Start services (assumes setup was done previously)
docker compose up -d

# View logs
docker compose logs -f

# Stop services
docker compose down

# Stop and remove volumes (WARNING: deletes data)
docker compose down -v

# Check service status
docker compose ps
```

### Access MongoDB
```bash
# With default password
docker compose exec mongod mongosh -u admin -p admin --authenticationDatabase admin

# With custom password (replace with your actual password)
docker compose exec mongod mongosh -u admin -p "your_admin_password" --authenticationDatabase admin
```

## Connecting to Services

### MongoDB Connection
```bash
# With default passwords
mongodb://admin:admin@localhost:27017/?authSource=admin

# With custom passwords (replace with your actual passwords)
mongodb://admin:[your_admin_password]@localhost:27017/?authSource=admin
```

### mongot Health Check
```
curl http://localhost:8080/health
```

### mongot Metrics
```
curl http://localhost:9946/metrics
```

## Troubleshooting

### Check Service Health
```bash
docker compose ps
docker compose logs mongod
docker compose logs mongot

# Check setup logs if you ran the setup recently
docker compose logs setup-generator
```

### Keyfile Issues
If you encounter keyfile permission issues:
```bash
# Regenerate keyfile and passwordFile (change passwords if necessary)
rm keyfile passwordFile
export ADMIN_PASSWORD="admin"
export MONGOT_PASSWORD="mongotPassword"
docker compose --profile setup up setup-generator
```

### Reset Everything
```bash
# Stop and remove all data
docker compose down -v
rm -rf keyfile passwordFile

# Start fresh with default passwords
export ADMIN_PASSWORD="admin"
exort MONGOT_PASSWORD="mongotPassword"
docker compose --profile setup up setup-generator
docker compose up -d
```

### Change Passwords
To change passwords, stop services, regenerate the password file, and restart:
```bash
# Stop current services
docker compose down

# Remove password file (keyfile can remain)
rm passwordFile

# Regenerate password file with new password
export ADMIN_PASSWORD="newAdminPass" MONGOT_PASSWORD="newMongotPass" && docker compose --profile setup up setup-generator

# Restart services
docker compose up -d
```

### Common Issues

**Error: "no such file or directory" for keyfile or passwordFile**
- This happens when running `docker compose up` before running the setup phase
- Solution: Run setup first: `export ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" && docker compose --profile setup up setup-generator`

**Services won't start**
- Check if keyfile and passwordFile exist: `ls -la keyfile passwordFile`
- If missing, run setup: `export ADMIN_PASSWORD="admin" MONGOT_PASSWORD="mongotPassword" && docker compose --profile setup up setup-generator`
- Then start services: `docker compose up -d`

**MongoDB authentication errors**
- Ensure the passwordFile contains the correct mongot password
- Regenerate if needed: `rm passwordFile && export MONGOT_PASSWORD="yourPassword" && docker compose --profile setup up setup-generator`

## Network Configuration

The services communicate through a custom bridge network called `search-community`. The hostnames used internally are:
- `mongod.search-community` (MongoDB)
- `mongot-community.search-community` (mongot)

## Data Persistence
Data is persisted in docker volumes:
- prometheus_data
- grafana_data
- mongod_data
- mongod_configdb
- mongot_data

Sample data is loaded from `sampledata.archive` if present

All data directories are created automatically and persist between container restarts as long as the volumes are not deleted.

# Prometheus Monitoring Setup

This setup includes comprehensive monitoring with Prometheus and Grafana for both MongoDB Community Server and mongot metrics.

## Quick Start with Monitoring

```bash
# Set passwords (optional - defaults to admin/admin/mongotPassword)
export ADMIN_PASSWORD="your-admin-password"
export MONGOT_PASSWORD="your-mongot-password"
export GRAFANA_PASSWORD="your-grafana-password"

# Start the full stack with monitoring
./start-monitoring.sh
```

This provides:
- **MongoDB Community Server**: Monitored via MongoDB Exporter  
- **mongot (Atlas Search)**: Native Prometheus metrics endpoint
- **Prometheus**: Time-series database for metrics collection
- **Grafana**: Visualization and dashboarding with pre-built dashboard

## Access Points

| Service | URL | Default Credentials |
|---------|-----|-------------------|
| MongoDB | `mongodb://admin:admin@localhost:27017` | admin/admin |
| Prometheus Web UI | http://localhost:9090 | - |
| Grafana Dashboards | http://localhost:3000 | admin/admin |
| MongoDB Exporter Metrics | http://localhost:9216/metrics | - |
| mongot Native Metrics | http://localhost:9946/metrics | - |
| mongot Health Check | http://localhost:8080 | - |

## Available Metrics

### MongoDB Community Server Metrics (via exporter)
- `mongodb_up` - Server availability (1=up, 0=down)
- `mongodb_ss_connections` - Connection statistics (current, active, available)
- `mongodb_ss_network_*` - Network I/O metrics (bytesIn, bytesOut)
- `mongodb_ss_opcounters` - Operation counters (insert, query, update, delete)
- `mongodb_ss_mem_*` - Memory usage (resident, virtual in MB)
- `mongodb_ss_wt_*` - WiredTiger storage engine metrics
- `mongodb_dbstats_*` - Database statistics (collections, dataSize, indexSize)

### Mongot (Atlas Search) Metrics (native)
- `mongot_command_searchBetaCommandTotalLatency_seconds` - Search command latency
- `mongot_command_indexStatsCommandTotalLatency_seconds` - Index stats command latency
- `mongot_command_*Failure_total` - Command failure counters
- `mongot_*_executor_*` - Executor thread pool metrics

## Testing the Setup

```bash
# Test all monitoring endpoints (run automatically on startup)
./test-monitoring.sh

# Test dashboard metrics availability (run automatically on startup) 
./grafana/test-dashboard-metrics.sh

# Generate sample activity to populate dashboard metrics
./generate-metrics.sh
```

## Using Prometheus

1. Open http://localhost:9090
2. Use these example queries:
   ```promql
   # MongoDB connection count
   mongodb_ss_connections{conn_type="current"}
   
   # Operations per second by type
   rate(mongodb_ss_opcounters[5m])
   
   # Search command latency and rates
   rate(mongot_command_searchBetaCommandTotalLatency_seconds_count[5m])
   
   # All mongot metrics
   {__name__=~"mongot_.*"}
   
   # All MongoDB metrics
   {__name__=~"mongodb_.*"}
   ```

## Using Grafana

1. Open http://localhost:3000
2. Login with admin/admin (or your GRAFANA_PASSWORD)
3. The "MongoDB Community Search Monitoring" dashboard is automatically loaded with:
   - **Service Status**: MongoDB & Mongot availability
   - **Connection Metrics**: Current and active connections
   - **Operations Rate**: Database operations per second by type
   - **Memory Usage**: Resident and virtual memory consumption
   - **Network I/O**: Bytes in/out rates
   - **Search Metrics**: Search command latency, rates, and failures
   - **Database Stats**: Collection counts and data sizes
   - **WiredTiger Cache**: Cache usage and efficiency

## Understanding Search Index Metrics

Search index metrics in Grafana display MongoDB ObjectIds instead of human-readable names. To identify which index is which:

```bash
# Get search index mappings (using environment variables)
docker exec -it mongod-community mongosh \
  --username admin \
  --password "${ADMIN_PASSWORD:-admin}" \
  --authenticationDatabase admin \
  --eval "
db.adminCommand('listDatabases').databases.forEach(dbInfo => { 
  if (dbInfo.name !== 'admin' && dbInfo.name !== 'config' && dbInfo.name !== 'local') { 
    db = db.getSiblingDB(dbInfo.name); 
    db.runCommand('listCollections').cursor.firstBatch.forEach(coll => { 
      try { 
        db.getCollection(coll.name).aggregate([{\\$listSearchIndexes: {}}]).forEach(idx => 
          print(idx.id + ' = ' + dbInfo.name + '.' + coll.name + ' (' + idx.name + ' - ' + idx.type + ')')
        ); 
      } catch(e) {} 
    }); 
  } 
});
"
```

## Troubleshooting Monitoring

### Check Service Health
```bash
docker compose ps
docker compose logs mongod
docker compose logs mongot
docker compose logs mongodb-exporter
docker compose logs prometheus
docker compose logs grafana
```

### Verify Metrics Endpoints
```bash
# Test mongot metrics
curl http://localhost:9946/metrics

# Test MongoDB exporter metrics
curl http://localhost:9216/metrics | grep mongodb_up

# Test Prometheus targets
curl http://localhost:9090/api/v1/targets
```

### Common Issues
- **MongoDB Exporter fails**: Check MongoDB authentication and connectivity
- **Mongot metrics unavailable**: Verify mongot service is healthy at http://localhost:8080
- **Grafana dashboards empty**: Ensure Prometheus is successfully scraping both targets

### Stop ALL Services
```bash
# Stop all services
docker compose down

# Stop and remove all data (including Grafana dashboards)
docker compose down -v

# Remove the network (optional)
docker network rm search-community
```